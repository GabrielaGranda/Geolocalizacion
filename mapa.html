<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ubicación del Conductor</title>
    <style>
        #map { width: 100%; height: 90vh; }
        #status { padding: 10px; font-weight: bold; }
    </style>

    <!-- Leaflet para mapas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>

<h2>Ubicación en tiempo real con Check In/Out</h2>
<div id="status">Cargando ubicación…</div>
<div id="map"></div>

<script>
const id = new URLSearchParams(window.location.search).get("id");
const backendUrl = "https://geolocalizacion-iptg.onrender.com"; // tu backend

const map = L.map('map').setView([0, 0], 2);
L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let currentMarker = null;
const checkInMarkers = [];
const checkOutMarkers = [];
const statusDiv = document.getElementById("status");

// Función para cargar ubicación y check-in/out
async function loadData() {
    try {
        // Evitar cache
        const resLocation = await fetch(`${backendUrl}/get_location/${id}?t=${new Date().getTime()}`, {cache:"no-store"});
        const locationData = await resLocation.json();

        const resChecks = await fetch(`${backendUrl}/get_checks/${id}?t=${new Date().getTime()}`, {cache:"no-store"});
        const checkData = await resChecks.json();

        // Mostrar ubicación actual
        if (locationData.lat && locationData.lng) {
            statusDiv.textContent = `Última ubicación (precisión: ${locationData.accuracy} m)`;

            if (!currentMarker) {
                currentMarker = L.marker([locationData.lat, locationData.lng], {title:"Ubicación actual"}).addTo(map);
                map.setView([locationData.lat, locationData.lng], 15);
            } else {
                currentMarker.setLatLng([locationData.lat, locationData.lng]);
            }
        } else {
            statusDiv.textContent = "No hay ubicación disponible todavía.";
        }

        // Mostrar check-ins (verde)
        if (checkData.checkin) {
            checkData.checkin.forEach(ts => {
                const parts = ts.split(" ");
                const lat = locationData.lat; // opcional: si quieres ubicar check en la misma posición
                const lng = locationData.lng;
                const marker = L.circleMarker([lat, lng], {color:"green", radius:8}).addTo(map);
                marker.bindPopup(`Check In: ${ts}`);
                checkInMarkers.push(marker);
            });
        }

        // Mostrar check-outs (rojo)
        if (checkData.checkout) {
            checkData.checkout.forEach(ts => {
                const lat = locationData.lat;
                const lng = locationData.lng;
                const marker = L.circleMarker([lat, lng], {color:"red", radius:8}).addTo(map);
                marker.bindPopup(`Check Out: ${ts}`);
                checkOutMarkers.push(marker);
            });
        }

    } catch(err) {
        statusDiv.textContent = "Error al obtener datos del backend: " + err;
        console.error(err);
    }
}

// Cargar cada 3 segundos
setInterval(loadData, 3000);
loadData();
</script>

</body>
</html>

